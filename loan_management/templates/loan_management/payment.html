{% extends 'common_base.html' %}
{% block common_title %}Loan Payment{% endblock %}
{% block common_body %}
  <div class="p-6">
    <!-- loan header -->
    <div class="flex items-center justify-between border-2 rounded-2xl p-6">
      <h1 class="text-2xl font-medium">Loan {{ loan.id }}. {{ loan.member }}</h1>
      <span class="border-2 rounded-full px-6 py-2">Outstanding: {{ loan.outstanding_principal }}</span>
    </div>
    <!-- payment card -->
    <div class="border-2 rounded-4xl mt-6 p-4">
      <div class="flex justify-between">
        <form method="get" class="inline">
          <label for="payment-select">Payment Type:</label>
          <select id="payment-select"
                  name="payment_type"
                  onchange="this.form.submit()"
                  class="border-2 rounded-md px-8 py-1 focus:outline-none focus:ring-2 transition-all duration-200 cursor-pointer">
            <option value="interest"
                    {% if request.GET.payment_type == "interest" or request.GET.payment_type == None %}selected{% endif %}>
              Interest
            </option>
            <option value="overdue"
                    {% if request.GET.payment_type == "overdue" %}selected{% endif %}>Overdues</option>
            <option value="principal"
                    {% if request.GET.payment_type == "principal" %}selected{% endif %}>Principal</option>
          </select>
        </form>
        {% now "N j, Y" as today %}
        <span>Date: {{ today }}</span>
      </div>
      <div class="mt-6">
        {% if request.GET.payment_type == 'interest' or not request.GET.payment_type %}
          <!-- interest payment form -->
          <form id="confirm-payment-form"
                method='POST'
                action="{% url 'loan:pay_interest' loan.id %}">
            {% csrf_token %}
            <div id="interest-type">
              <div>
                <input id="regular"
                       type="radio"
                       name="interest-type"
                       value="regular"
                       checked>
                <label for="regular">Pay Current Due Amount</label>
              </div>
              <div>
                <input id="to-date" type="radio" name="interest-type" value="to-date">
                <label for="to-date">Pay Dues to Date</label>
              </div>
              <div>
                <input id="custom" type="radio" name="interest-type" value="custom">
                <label for="custom">Custom</label>
              </div>
            </div>
            <!-- Interest amount input -->
            <div id="amount-container" class="flex items-end gap-4 hidden">
              <div>
                <label for="interest-amount">Amount:</label>
                <input id="interest-amount"
                       type="number"
                       step="0.01"
                       name="amount"
                       class="border-2 rounded-md px-2 py-1">
              </div>
            </div>
            <!--interest confirm payments -->
            <div class="text-end mt-4">
              <button id="interest-confirm"
                      type="submit"
                      class="border-2 px-12 py-2 rounded-lg text-sm hover:shadow-lg hover:shadow-gray-600 hover:-translate-0.5 transition-all duration-200 cursor-pointer">
                Confirm Payments
              </button>
            </div>
          </form>
        {% elif request.GET.payment_type == 'principal' %}
          <!-- principal payment form -->
          <form id="confirm-payment-form"
                method='POST'
                action="{% url 'loan:pay_principal' loan.id %}">
            {% csrf_token %}
            <!-- principal amount input -->
            <div id="amount-container" class="flex items-end gap-4">
              <div>
                <label for="principal-amount">Amount:</label>
                <input id="principal-amount"
                       required
                       type="number"
                       name="principal-amount"
                       class="border-2 rounded-md px-2 py-1">
              </div>
            </div>
            <!-- principal confirm payments -->
            <div class="text-end mt-4">
              <button id="principal-confirm"
                      type="submit"
                      class="border-2 px-12 py-2 rounded-lg text-sm hover:shadow-lg hover:shadow-gray-600 hover:-translate-0.5 transition-all duration-200 cursor-pointer">
                Confirm Payments
              </button>
            </div>
          </form>
          <hr class="border-2 mt-4">
          <!-- calculated payment -->
          <div class="mt-4 overflow-x-auto">
            <table class="min-w-full">
              <thead class="text-center">
                <tr>
                  <th class="p-2">Date</th>
                  <th class="p-2">Amount</th>
                </tr>
              </thead>
              <tbody class="text-center">
                <tr>
                  {% now "N j, Y" as today %}
                  <td id="date-Col" class="p-2">{{ today }}</td>
                  <td id="principal-amount-col" class="p-2"></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      {% endif %}
    </div>
    <hr class="border-2 mt-4">
    <!-- calculated payment -->
    <div class="mt-4 overflow-x-auto">
      <table class="min-w-full">
        <thead class="text-center">
          <tr>
            <th class="p-2">Amount</th>
            <th class="p-2">Period Start</th>
            <th class="p-2">Period End</th>
            <th class="p-2">Days</th>
            {% if request.GET.payment_type == 'overdue' %}
              <th class="p-2">Fees</th>
              <th class="p-2">Action</th>
            {% endif %}
          </tr>
        </thead>
        <tbody class="text-center">
          {% for ci in calculated_interest %}
            <tr>
              <td id="total-col" class="p-2">{{ ci.total }}</td>
              <td id="period-start-col" class="p-2">{{ ci.period_start }}</td>
              <td id="period-end-col" class="p-2">{{ ci.period_end }}</td>
              <td id="days-col" class="p-2">{{ ci.days }}</td>
              {% if request.GET.payment_type == 'overdue' %}
                <td id="fees-col" class="p-2 text-center">
                  <!-- Pay Now -->
                  <form method="POST"
                        action="{% url 'loan:pay_interest' loan.id %}"
                        style="display: inline">
                    {% csrf_token %}
                    <label class="inline-flex items-center justify-center gap-1 cursor-pointer">
                      <div class="relative flex items-center justify-center">
                        <input type="checkbox" class="sr-only peer" name="fees" checked>
                        <div class="w-7 h-4 border-3 border-gray-400 rounded-full peer-checked:border-black transition-colors duration-200">
                        </div>
                        <div class="absolute left-0.5 top-0.5 w-3 h-3 border border-gray-400 bg-white rounded-full transition-all duration-200 peer-checked:translate-x-3 peer-checked:border-black">
                        </div>
                      </div>
                      <span class="text-gray-700 text-sm">5.00</span>
                    </label>
                  </td>
                  <td id="action-col" class="p-2">
                    <input id="overdue" type="hidden" name="interest-type" value="overdue">
                    <input type="hidden" name="overdue_id" value="{{ ci.id }}">
                    <button type="submit"
                            {% if not ci.is_payable %}disabled{% endif %}
                            class="border-2 px-3 py-1.5 rounded-lg text-sm {% if ci.is_payable %} hover:shadow-lg hover:shadow-gray-600 hover:-translate-0.5 cursor-pointer {% else %} opacity-50 cursor-not-allowed bg-gray-100 {% endif %} transition-all duration-200">
                      {% if ci.is_payable %}
                        Pay Now
                      {% else %}
                        Locked
                      {% endif %}
                    </button>
                  </form>
                </td>
              {% endif %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  <!-- payment history -->
  <div class="border-2 rounded-4xl mt-6 p-6 overflow-x-auto">
    <table class="min-w-full">
      <thead>
        <tr class="divide-x-2">
          <th class="p-4">Date</th>
          <th class="p-4">Type</th>
          <th class="p-4">Amount</th>
          <th class="p-4">Period Start</th>
          <th class="p-4">Period End</th>
          <th class="p-4">Transaction</th>
        </tr>
      </thead>
      <tbody class="text-center">
        {% for ph in payment_history %}
          <tr class="divide-x-2 rounded-full hover:shadow-lg hover:shadow-gray-600 hover:-translate-0.5 transition-all duration-200">
            <td class="p-4">{{ ph.date }}</td>
            <td class="p-4">{{ ph.type }}</td>
            <td class="p-4">{{ ph.amount }}</td>
            <td class="p-4">{{ ph.period_start }}</td>
            <td class="p-4">{{ ph.period_end }}</td>
            <td class="p-4">{{ ph.transaction }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
